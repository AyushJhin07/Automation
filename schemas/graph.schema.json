{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://apps-script-studio.com/schemas/graph.schema.json",
  "title": "NodeGraph",
  "description": "A directed acyclic graph representing a Google Apps Script automation workflow",
  "type": "object",
  "required": [
    "id",
    "name",
    "nodes",
    "edges",
    "metadata"
  ],
  "properties": {
    "id": {
      "type": "string",
      "pattern": "^[a-zA-Z0-9_-]+$",
      "description": "Unique identifier for the graph"
    },
    "name": {
      "type": "string",
      "minLength": 1,
      "maxLength": 100,
      "description": "Human-readable name for the automation"
    },
    "description": {
      "type": "string",
      "maxLength": 500,
      "description": "Optional description of what this automation does"
    },
    "nodes": {
      "type": "array",
      "minItems": 1,
      "items": {
        "$ref": "#/definitions/Node"
      }
    },
    "edges": {
      "type": "array",
      "items": {
        "$ref": "#/definitions/Edge"
      }
    },
    "metadata": {
      "type": "object",
      "properties": {
        "version": {
          "type": "string",
          "pattern": "^\\d+\\.\\d+\\.\\d+$"
        },
        "createdAt": {
          "type": "string",
          "format": "date-time"
        },
        "updatedAt": {
          "type": "string",
          "format": "date-time"
        },
        "author": {
          "type": "string"
        },
        "tags": {
          "type": "array",
          "items": {
            "type": "string"
          }
        }
      },
      "required": [
        "version",
        "createdAt"
      ]
    }
  },
  "definitions": {
    "Node": {
      "type": "object",
      "required": [
        "id",
        "type",
        "position"
      ],
      "properties": {
        "id": {
          "type": "string",
          "pattern": "^[a-zA-Z0-9_-]+$"
        },
        "type": {
          "type": "string",
          "pattern": "^(trigger|action|transform|condition|delay|logger|loop)(\\.[a-z0-9_-]+){1,5}$",
          "description": "Node type identifier in the format category.app.operation (e.g. action.gmail.send_email)"
        },
        "position": {
          "type": "object",
          "required": [
            "x",
            "y"
          ],
          "properties": {
            "x": {
              "type": "number"
            },
            "y": {
              "type": "number"
            }
          }
        },
        "data": {
          "type": "object",
          "description": "Node-specific configuration data",
          "properties": {
            "parameters": {
              "type": "object",
              "description": "Structured parameter values for the node"
            },
            "bodyNodeIds": {
              "type": "array",
              "description": "For loop nodes, the identifiers of nodes that execute within the loop body",
              "items": {
                "type": "string"
              }
            },
            "itemAlias": {
              "type": "string",
              "description": "Optional alias that child nodes can use to reference the current loop item",
              "minLength": 1,
              "maxLength": 50
            }
          },
          "additionalProperties": true
        },
        "label": {
          "type": "string",
          "maxLength": 50
        }
      }
    },
    "Edge": {
      "type": "object",
      "required": [
        "id",
        "source",
        "target"
      ],
      "properties": {
        "id": {
          "type": "string",
          "pattern": "^[a-zA-Z0-9_-]+$"
        },
        "source": {
          "type": "string",
          "description": "Source node ID"
        },
        "target": {
          "type": "string",
          "description": "Target node ID"
        },
        "sourceHandle": {
          "type": "string",
          "description": "Optional source handle ID"
        },
        "targetHandle": {
          "type": "string",
          "description": "Optional target handle ID"
        },
        "condition": {
          "type": "object",
          "description": "Optional condition for conditional edges"
        }
      }
    }
  },
  "allOf": [
    {
      "if": {
        "properties": {
          "type": {
            "pattern": "^loop(\\.[a-z0-9_-]+){1,5}$"
          }
        },
        "required": ["type"]
      },
      "then": {
        "properties": {
          "data": {
            "type": "object",
            "description": "Configuration for loop execution",
            "required": ["parameters"],
            "properties": {
              "parameters": {
                "type": "object",
                "required": ["collection", "itemAlias"],
                "properties": {
                  "collection": {
                    "description": "Value or reference resolving to the collection that should be iterated",
                    "oneOf": [
                      { "type": "array" },
                      { "type": "object" },
                      { "type": "string" },
                      { "type": "number" },
                      { "type": "boolean" },
                      { "type": "null" }
                    ]
                  },
                  "itemAlias": {
                    "type": "string",
                    "minLength": 1,
                    "maxLength": 50,
                    "description": "Name exposed to child nodes for the current item"
                  }
                }
              },
              "bodyNodeIds": {
                "type": "array",
                "items": { "type": "string" },
                "description": "Identifiers for nodes that should execute inside the loop body"
              }
            }
          }
        },
        "required": ["data"]
      }
    }
  ]
}
